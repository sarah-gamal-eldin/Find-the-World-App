<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Find the World ‚Äì Interactive Geography Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
<link rel="icon" href="data:,">
<style>
  body, html { margin:0; padding:0; height:100%; width:100%; font-family:sans-serif; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #appName {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    background: rgba(255, 255, 255, 0.85); color:#212121;
    padding:10px 20px; border-radius:12px; font-size:20px;
    font-weight:bold; text-shadow:1px 1px 2px #000;
    box-shadow:0 3px 8px rgba(0,0,0,0.4); pointer-events:none;
    z-index:10;
  }
  #info {
    position:absolute; background: rgba(0,0,0,0.8); color: white;
    padding:12px; border-radius:8px; box-shadow:0 3px 8px rgba(0,0,0,0.5);
    font-size:15px; line-height:1.5em; max-width:250px; pointer-events:auto;
  }
  #info button {
    margin-top:8px; padding:4px 8px; border:none;
    background:#FFC107; color:black; border-radius:4px; cursor:pointer;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="appName">üåç Find the World</div>
<div id="info">üéÆ Loading quiz...</div>

<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script src="./pmtiles.js"></script>

<script>
const protocol = new pmtiles.Protocol();
maplibregl.addProtocol("pmtiles", protocol.tile.bind(protocol));

const map = new maplibregl.Map({
  container: "map",
  style: { version:8, glyphs:"https://cdn.maptiler.com/fonts/{fontstack}/{range}.pbf", sources:{}, layers:[] },
  center:[0,20], zoom:2
});

const info = document.getElementById("info");
let target=null, countryFeatures=[], heritageFeatures=[], placeFeatures=[];

function pickRandomTarget(){
  const pool=[];
  if(countryFeatures.length) pool.push({type:"country", f:countryFeatures[Math.floor(Math.random()*countryFeatures.length)]});
  if(heritageFeatures.length) pool.push({type:"heritage", f:heritageFeatures[Math.floor(Math.random()*heritageFeatures.length)]});
  if(placeFeatures.length) pool.push({type:"place", f:placeFeatures[Math.floor(Math.random()*placeFeatures.length)]});
  if(pool.length===0) return;
  const chosen=pool[Math.floor(Math.random()*pool.length)];
  target=chosen;
  let label="";
  if(chosen.type==="country") label=chosen.f.properties.ADMIN;
  if(chosen.type==="heritage") label=chosen.f.properties.name_en||chosen.f.properties.NAME||"heritage site";
  if(chosen.type==="place") label=chosen.f.properties.NAME||"city";
  info.innerHTML=`üåç Find <b>${label}</b> on the map! Click to answer.`;
}

map.on("load",()=>{
  // Dark basemap
  map.addSource("raster-basemap",{type:"raster", tiles:["https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png"], tileSize:256});
  map.addLayer({id:"basemap", type:"raster", source:"raster-basemap"});

  // Countries
  map.addSource("countries",{type:"vector", url:"pmtiles://https://pub-1986f349473349489dd23c0053575aad.r2.dev/app_data/admin_0_countries.pmtiles"});
  map.addLayer({id:"countries-fill", type:"fill", source:"countries", "source-layer":"admin_0_countries", paint:{"fill-color":"#2196F3","fill-opacity":0.15,"fill-outline-color":"#fff"}});
  map.addLayer({id:"countries-outline", type:"line", source:"countries", "source-layer":"admin_0_countries", paint:{"line-color":"#64B5F6","line-width":1}});
  
  map.on("mousemove","countries-fill",()=>{ map.setPaintProperty("countries-fill","fill-opacity",0.4); map.getCanvas().style.cursor="pointer"; });
  map.on("mouseleave","countries-fill",()=>{ map.setPaintProperty("countries-fill","fill-opacity",0.15); map.getCanvas().style.cursor=""; });

  // Populated places
  map.addSource("places",{type:"vector", url:"pmtiles://https://pub-1986f349473349489dd23c0053575aad.r2.dev/app_data/110m_populated_places.pmtiles"});
  map.addLayer({id:"places-circle", type:"circle", source:"places", "source-layer":"110m_populated_places", paint:{"circle-radius":6,"circle-color":"#E91E63","circle-stroke-width":2,"circle-stroke-color":"#fff"}});
  map.addLayer({id:"places-label", type:"symbol", source:"places", "source-layer":"110m_populated_places", layout:{"text-field":["get","NAME"],"text-font":["sans-serif"],"text-size":12,"text-offset":[0,1.5]}, paint:{"text-color":"#E91E63"}});

  // Heritage
  map.addSource("heritage",{type:"vector", url:"pmtiles://https://pub-1986f349473349489dd23c0053575aad.r2.dev/app_data/world_heritage_sites.pmtiles"});
  map.addLayer({id:"heritage-points", type:"circle", source:"heritage", "source-layer":"world_heritage_sites", paint:{"circle-radius":7,"circle-color":"#FF5722","circle-stroke-width":2,"circle-stroke-color":"#fff"}});
  map.addLayer({id:"heritage-label", type:"symbol", source:"heritage", "source-layer":"world_heritage_sites", layout:{"text-field":["get","name_en"],"text-font":["sans-serif"],"text-size":12,"text-offset":[0,1.5]}, paint:{"text-color":"#FF5722"}});

  map.once("idle",()=>{
    countryFeatures = map.querySourceFeatures("countries",{sourceLayer:"admin_0_countries"});
    heritageFeatures = map.querySourceFeatures("heritage",{sourceLayer:"world_heritage_sites"});
    placeFeatures = map.querySourceFeatures("places",{sourceLayer:"110m_populated_places"});
    pickRandomTarget();
  });

  map.on("click",(e)=>{
    const features=map.queryRenderedFeatures(e.point,{layers:["countries-fill","heritage-points","places-circle","places-label"]});
    if(features.length>0){
      const clicked=features[0];
      let clickedName=clicked.properties.ADMIN||clicked.properties.NAME||clicked.properties.name_en||"unknown";
      info.style.left=`${e.point.x+10}px`; info.style.top=`${e.point.y+10}px`;
      let correct=false;
      if(target){
        if(target.type==="country" && clicked.layer.id==="countries-fill" && clicked.properties.ADMIN===target.f.properties.ADMIN) correct=true;
        if(target.type==="heritage" && clicked.layer.id==="heritage-points" && clicked.properties.name_en===target.f.properties.name_en) correct=true;
        if(target.type==="place" && (clicked.layer.id==="places-label"||clicked.layer.id==="places-circle") && clicked.properties.NAME===target.f.properties.NAME) correct=true;
      }
      if(correct){ info.innerHTML=`‚úÖ Correct! You found <b>${clickedName}</b>. Next round coming...`; setTimeout(()=>pickRandomTarget(),2000); }
      else{ info.innerHTML=`‚ùå You clicked <b>${clickedName}</b>. Try again!<br><button id="tryAgain">Try Again</button>`; document.getElementById("tryAgain").onclick=()=>{ pickRandomTarget(); }; }
    }
  });
});
</script>
</body>
</html>
