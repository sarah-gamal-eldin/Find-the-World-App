<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Find the World ‚Äì Interactive Geography Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
<style>
  body, html { margin:0; padding:0; height:100%; width:100%; font-family:sans-serif; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #appName {
    position:absolute; top:10px; left:50%; transform:translateX(-50%);
    background: rgba(255, 255, 255, 0.85); color:#212121;
    padding:10px 20px; border-radius:12px; font-size:20px;
    font-weight:bold; text-shadow:1px 1px 2px #000;
    box-shadow:0 3px 8px rgba(0,0,0,0.4); pointer-events:none;
    z-index:10;
  }
  #info {
    position:absolute; background: rgba(0,0,0,0.8); color: white;
    padding:12px; border-radius:8px; box-shadow:0 3px 8px rgba(0,0,0,0.5);
    font-size:15px; line-height:1.5em; max-width:300px; pointer-events:auto;
  }
  #info button {
    margin-top:8px; padding:4px 8px; border:none;
    background:#FFC107; color:black; border-radius:4px; cursor:pointer;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="appName">üåç Find the World</div>
<div id="info">üéÆ Loading quiz...</div>

<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script src="./pmtiles.js"></script>

<script>
// Calculate polygon centroid
function getCentroid(coords) {
  let area = 0, x = 0, y = 0;
  const points = coords[0];
  for(let i=0;i<points.length-1;i++){
    const xi = points[i][0], yi = points[i][1];
    const xi1 = points[i+1][0], yi1 = points[i+1][1];
    const a = xi*yi1 - xi1*yi;
    area += a;
    x += (xi+xi1)*a;
    y += (yi+yi1)*a;
  }
  area /= 2;
  x /= (6*area);
  y /= (6*area);
  return [x,y];
}

const protocol = new pmtiles.Protocol();
maplibregl.addProtocol("pmtiles", protocol.tile.bind(protocol));

const map = new maplibregl.Map({
  container: "map",
  style: { version:8, glyphs:"https://cdn.maptiler.com/fonts/{fontstack}/{range}.pbf", sources:{}, layers:[] },
  center:[0,20], zoom:2
});

const info = document.getElementById("info");
let target=null, countryFeatures=[], correctCountries=[], score=0, attempts=0;

function pickRandomTarget(){
  const remaining = countryFeatures.filter(f=>!correctCountries.includes(f.properties.ADMIN));
  if(remaining.length===0){
    info.innerHTML=`üéâ You found all countries! Final score: ${score}/${attempts}`;
    return;
  }
  const chosen = remaining[Math.floor(Math.random()*remaining.length)];
  target = chosen;
  info.innerHTML=`üåç Find <b>${target.properties.ADMIN}</b> on the map! Score: ${score}/${attempts}`;
}

map.on("load",()=>{
  map.addSource("raster-basemap",{type:"raster", tiles:["https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png"], tileSize:256});
  map.addLayer({id:"basemap", type:"raster", source:"raster-basemap"});

  map.addSource("countries",{type:"vector", url:"pmtiles://https://pub-1986f349473349489dd23c0053575aad.r2.dev/app_data/admin_0_countries.pmtiles"});
  map.addLayer({id:"countries-fill", type:"fill", source:"countries", "source-layer":"admin_0_countries", paint:{"fill-color":"#2196F3","fill-opacity":0.15,"fill-outline-color":"#fff"}});
  map.addLayer({id:"countries-outline", type:"line", source:"countries", "source-layer":"admin_0_countries", paint:{"line-color":"#64B5F6","line-width":1}});
  
  // Correct selection
  map.addLayer({id:"countries-selected", type:"fill", source:"countries", "source-layer":"admin_0_countries", paint:{"fill-color":"#00E676","fill-opacity":0.5}, filter:["in","ADMIN",""]});
  
  // Temporary highlight for wrong clicks
  map.addLayer({id:"countries-temp", type:"fill", source:"countries", "source-layer":"admin_0_countries", paint:{"fill-color":"#FF5252","fill-opacity":0.5}, filter:["in","ADMIN",""]});
  
  // Labels for correct countries
  map.addSource("country-labels", { type:"geojson", data: { type:"FeatureCollection", features:[] } });
  map.addLayer({
    id:"countries-label",
    type:"symbol",
    source:"country-labels",
    layout:{
      "text-field":["get","ADMIN"],
      "text-font":["sans-serif"],
      "text-size":14,
      "text-anchor":"center"
    },
    paint:{ "text-color":"#212121" }
  });

  map.once("idle",()=>{
    countryFeatures = map.querySourceFeatures("countries",{sourceLayer:"admin_0_countries"});
    pickRandomTarget();
  });

  map.on("click",(e)=>{
    const features = map.queryRenderedFeatures(e.point, { layers:["countries-fill"] });
    if(features.length>0){
      const clicked = features[0];
      const clickedName = clicked.properties.ADMIN;
      attempts++;

      let correct=false;
      if(target && clickedName===target.properties.ADMIN) correct=true;

      if(correct && !correctCountries.includes(clickedName)){
        score++;
        correctCountries.push(clickedName);
      }

      // Update selected countries
      map.setFilter("countries-selected", ["in","ADMIN", ...correctCountries]);

      // Update labels for correct countries
      const labelFeatures = correctCountries.map(name=>{
        const f = countryFeatures.find(c=>c.properties.ADMIN===name);
        if(!f) return null;
        const centroid = getCentroid(f.geometry.coordinates);
        return { type:"Feature", geometry:{ type:"Point", coordinates:centroid }, properties:{ ADMIN:name } };
      }).filter(f=>f!==null);
      map.getSource("country-labels").setData({ type:"FeatureCollection", features:labelFeatures });

      // Temporary highlight for wrong click
      if(!correct){
        map.setFilter("countries-temp", ["in","ADMIN", clickedName]);
        setTimeout(()=>{ map.setFilter("countries-temp", ["in","ADMIN"]); }, 800);
      }

      info.innerHTML = `${correct ? '‚úÖ Correct!' : '‚ùå Incorrect!'} You clicked <b>${clickedName}</b>.<br>Score: ${score}/${attempts}<br><button id="next">Next</button>`;
      document.getElementById("next").onclick=()=>{ pickRandomTarget(); };
    }
  });
});
</script>
</body>
</html>
